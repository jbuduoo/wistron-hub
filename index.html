<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·¯å‰µåˆ†äº«å¹³å°</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="css/styles.css?v=4">
</head>
<body>
    <!-- é ‚éƒ¨å°èˆªæ¬„ -->
    <header class="header">
        <div class="header-left">
            <div class="logo">
                <h1>Wistron Share</h1>
                <span class="logo-subtitle">ç·¯å‰µåˆ†äº«å¹³å°</span>
            </div>
        </div>
        <div class="header-center">
            <div class="search-box">
                <input type="text" placeholder="æœå°‹æœ€æ–°æ¶ˆæ¯ã€å½±ç‰‡ã€æ–‡ç« ã€æ‡¸è³ã€ä½œå“ã€å°ˆæ¡ˆæ”¯æ´æˆ–å…§éƒ¨å°ˆå®¶..." id="searchInput">
                <button class="search-btn" title="æœå°‹">ğŸ”</button>
            </div>
        </div>
        <div class="header-right" id="headerRight">
            <!-- ç™»å…¥å‰é¡¯ç¤º -->
            <button class="login-btn-header" id="loginBtn" onclick="window.location.href='login.html'">ç™»å…¥</button>
            
            <!-- ç™»å…¥å¾Œé¡¯ç¤º -->
            <div id="loggedInSection" style="display: none;">
                <button class="upload-btn" onclick="window.location.href='upload.html'">ğŸ“¤ ä¸Šå‚³å…§å®¹</button>
                <div class="user-avatar" id="userAvatar" onclick="showUserMenu()">
                    <img src="" alt="ç”¨æˆ¶é ­åƒ" id="avatarImg" style="display: none;">
                    <span id="avatarInitial">ğŸ‘¤</span>
                    <span class="online-dot"></span>
                </div>
                <div class="user-points" id="userPoints">
                    <span class="points-icon">â­</span>
                    <span class="points-label">çŸ¥è­˜ç©åˆ†ï¼š</span>
                    <span class="points-value" id="pointsValue">0</span>
                </div>
            </div>
        </div>
        
        <!-- ç”¨æˆ¶é¸å–® -->
        <div class="user-menu" id="userMenu" style="display: none;">
            <div class="user-menu-header">
                <div class="user-menu-avatar" id="menuAvatar">
                    <span id="menuAvatarInitial">ğŸ‘¤</span>
                </div>
                <div class="user-menu-info">
                    <div class="user-menu-name" id="menuUserName">ç”¨æˆ¶åç¨±</div>
                    <div class="user-menu-username" id="menuUserUsername">@username</div>
                </div>
            </div>
            <div class="user-menu-divider"></div>
            <a href="#" class="user-menu-item" onclick="window.location.href='upload.html'">ğŸ“¤ ä¸Šå‚³å…§å®¹</a>
            <a href="#" class="user-menu-item" id="adminMenuLink" style="display: none;" onclick="window.location.href='admin.html'">âš™ï¸ å¾Œå°ç®¡ç†</a>
            <a href="#" class="user-menu-item" onclick="logout()">ğŸšª ç™»å‡º</a>
        </div>
    </header>

    <div class="container">
        <!-- å´é‚Šæ¬„ -->
        <aside class="sidebar">
            <nav class="sidebar-nav" id="sidebarNav">
                <!-- å´é‚Šæ¬„é …ç›®å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
            </nav>
        </aside>

        <!-- ä¸»è¦å…§å®¹å€ -->
        <main class="main-content">
            <div class="content-header">
                <h2 id="contentTitle">æœ€æ–°æ¶ˆæ¯</h2>
                <div class="sort-options">
                    <select id="sortSelect">
                        <option value="newest">æœ€æ–°ç™¼å¸ƒ</option>
                        <option value="popular">æœ€å—æ­¡è¿</option>
                        <option value="reward">èªè­‰ç­‰ç´š</option>
                    </select>
                </div>
            </div>

            <!-- å…§å®¹ç¶²æ ¼ -->
            <div class="content-grid" id="contentGrid">
                <!-- å…§å®¹å¡ç‰‡å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
            </div>

            <!-- ç©ºç‹€æ…‹ -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <p>ç›®å‰é‚„æ²’æœ‰æœ€æ–°æ¶ˆæ¯ï¼Œæˆç‚ºç¬¬ä¸€å€‹ç™¼å¸ƒçš„äººå§ï¼</p>
                <button class="btn-primary" onclick="window.location.href='upload.html'">ç«‹å³ä¸Šå‚³</button>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js?v=2"></script>
    <script src="js/supabase-api.js?v=3"></script>
    <script src="js/auth.js?v=2"></script>
    <script src="js/script.js?v=3"></script>
    <script>
        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹ä¸¦æ›´æ–° header
        function updateHeaderForAuth() {
            const isLoggedIn = Auth.isLoggedIn();
            const loginBtn = document.getElementById('loginBtn');
            const loggedInSection = document.getElementById('loggedInSection');
            
            if (isLoggedIn) {
                if (loginBtn) loginBtn.style.display = 'none';
                if (loggedInSection) loggedInSection.style.display = 'flex';
                
                const user = Auth.getCurrentUser();
                if (user) {
                    // æ›´æ–°é ­åƒ
                    const avatarImg = document.getElementById('avatarImg');
                    const avatarInitial = document.getElementById('avatarInitial');
                    const menuAvatarInitial = document.getElementById('menuAvatarInitial');
                    
                    if (avatarImg && avatarInitial) {
                        if (user.avatar) {
                            avatarImg.src = user.avatar;
                            avatarImg.style.display = 'block';
                            avatarInitial.style.display = 'none';
                        } else {
                            avatarInitial.textContent = user.name ? user.name.charAt(0) : 'ğŸ‘¤';
                        }
                    }
                    
                    if (menuAvatarInitial) {
                        menuAvatarInitial.textContent = user.name ? user.name.charAt(0) : 'ğŸ‘¤';
                    }
                    
                    // æ›´æ–°é¸å–®è³‡è¨Š
                    const menuUserName = document.getElementById('menuUserName');
                    const menuUserUsername = document.getElementById('menuUserUsername');
                    if (menuUserName) menuUserName.textContent = user.name || user.username;
                    if (menuUserUsername) menuUserUsername.textContent = '@' + user.username;
                    
                    // é¡¯ç¤ºç®¡ç†å“¡é¸å–®é€£çµ
                    const adminMenuLink = document.getElementById('adminMenuLink');
                    if (adminMenuLink && Auth.isAdmin()) {
                        adminMenuLink.style.display = 'block';
                    }
                }
                
                // è¼‰å…¥ç”¨æˆ¶ç©åˆ†
                if (typeof loadUserPoints !== 'undefined') {
                    loadUserPoints();
                }
            } else {
                if (loginBtn) loginBtn.style.display = 'block';
                if (loggedInSection) loggedInSection.style.display = 'none';
            }
        }
        
        function showUserMenu() {
            const menu = document.getElementById('userMenu');
            if (menu) {
                menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        function logout() {
            Auth.logout();
        }
        
        // é»æ“Šå¤–éƒ¨é—œé–‰é¸å–®
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('userMenu');
            const avatar = document.getElementById('userAvatar');
            if (menu && avatar && !menu.contains(e.target) && !avatar.contains(e.target)) {
                menu.style.display = 'none';
            }
        });
        
        // è¼‰å…¥å´é‚Šæ¬„é…ç½®
        async function loadSidebarNavigation() {
            const sidebarNav = document.getElementById('sidebarNav');
            if (!sidebarNav) return;
            
            // å¦‚æœ admin-api.js å·²è¼‰å…¥ï¼Œä½¿ç”¨å‹•æ…‹é…ç½®
            if (typeof getSidebarConfig !== 'undefined') {
                try {
                    const config = await getSidebarConfig();
                    const enabledItems = config.filter(item => item.enabled).sort((a, b) => a.order - b.order);
                    
                    sidebarNav.innerHTML = enabledItems.map((item, index) => `
                        <a href="#" class="nav-item ${index === 0 ? 'active' : ''}" data-filter="${item.filter}">
                            <span class="nav-icon">${item.icon}</span> ${item.label}
                        </a>
                    `).join('');
                    
                    // é‡æ–°ç¶å®šé»æ“Šäº‹ä»¶
                    bindSidebarClickEvents();
                } catch (error) {
                    console.warn('è¼‰å…¥å´é‚Šæ¬„é…ç½®å¤±æ•—ï¼Œä½¿ç”¨é è¨­é…ç½®:', error);
                    loadDefaultSidebar();
                }
            } else {
                // å¦‚æœ admin-api.js æœªè¼‰å…¥ï¼Œä½¿ç”¨é è¨­é…ç½®
                loadDefaultSidebar();
            }
        }
        
        function loadDefaultSidebar() {
            const sidebarNav = document.getElementById('sidebarNav');
            if (!sidebarNav) return;
            
            sidebarNav.innerHTML = `
                <a href="#" class="nav-item active" data-filter="news">
                    <span class="nav-icon">ğŸ“¢</span> æœ€æ–°æ¶ˆæ¯
                </a>
                <a href="#" class="nav-item" data-filter="all">
                    <span class="nav-icon">ğŸ†</span> 2025é»‘å®¢æ¾ç«¶è³½
                </a>
                <a href="#" class="nav-item" data-filter="video">
                    <span class="nav-icon">ğŸ¬</span> å½±ç‰‡åˆ†äº«
                </a>
                <a href="#" class="nav-item" data-filter="article">
                    <span class="nav-icon">ğŸ“„</span> æ–‡ç« åˆ†äº«
                </a>
                <a href="#" class="nav-item" data-filter="suggestion">
                    <span class="nav-icon">ğŸ’°</span> æ‡¸è³å€
                </a>
                <a href="#" class="nav-item" data-filter="project">
                    <span class="nav-icon">ğŸ’»</span> ä½œå“åˆ†äº«
                </a>
                <a href="#" class="nav-item" data-filter="job">
                    <span class="nav-icon">ğŸ¤</span> å°ˆæ¡ˆæ”¯æ´æŠ€èƒ½åª’åˆ
                </a>
                <a href="#" class="nav-item" data-filter="expert">
                    <span class="nav-icon">ğŸ¤</span> æ‰¾å…§éƒ¨å°ˆå®¶
                </a>
            `;
            bindSidebarClickEvents();
        }
        
        function bindSidebarClickEvents() {
            // å¦‚æœ script.js ä¸­çš„ setupSidebarFilter å­˜åœ¨ï¼Œä½¿ç”¨å®ƒ
            if (typeof setupSidebarFilter !== 'undefined') {
                setupSidebarFilter();
            } else {
                // å¦å‰‡æ‰‹å‹•ç¶å®šäº‹ä»¶
                const navItems = document.querySelectorAll('.nav-item');
                const contentTitle = document.getElementById('contentTitle');
                const titles = {
                    all: '2025é»‘å®¢æ¾ç«¶è³½',
                    news: 'æœ€æ–°æ¶ˆæ¯',
                    video: 'å½±ç‰‡åˆ†äº«',
                    article: 'æ–‡ç« åˆ†äº«',
                    suggestion: 'æ‡¸è³å€',
                    project: 'ä½œå“åˆ†äº«',
                    job: 'å°ˆæ¡ˆæ”¯æ´åŠæŠ€èƒ½åª’åˆ',
                    expert: 'æ‰¾å…§éƒ¨å°ˆå®¶'
                };
                
                navItems.forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        // ç§»é™¤æ‰€æœ‰ active é¡
                        navItems.forEach(nav => nav.classList.remove('active'));
                        // æ·»åŠ  active é¡åˆ°ç•¶å‰é …ç›®
                        this.classList.add('active');
                        // æ›´æ–°æ¨™é¡Œ
                        const filter = this.getAttribute('data-filter');
                        if (contentTitle) {
                            contentTitle.textContent = titles[filter] || 'å…¨éƒ¨å…§å®¹';
                        }
                        // è§¸ç™¼ç¯©é¸
                        const sortSelect = document.getElementById('sortSelect');
                        const sort = sortSelect ? sortSelect.value : 'newest';
                        if (typeof loadContent !== 'undefined') {
                            loadContent(filter, sort);
                        }
                    });
                });
            }
        }
        
        // é é¢è¼‰å…¥æ™‚æ›´æ–° header å’Œå´é‚Šæ¬„
        document.addEventListener('DOMContentLoaded', function() {
            updateHeaderForAuth();
            loadSidebarNavigation();
        });
    </script>
</body>
</html>

