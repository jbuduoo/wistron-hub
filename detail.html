<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…§å®¹è©³æƒ… - ç·¯å‰µåˆ†äº«å¹³å°</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- é ‚éƒ¨å°èˆªæ¬„ -->
    <header class="header">
        <div class="header-left">
            <div class="logo">
                <a href="index.html" style="text-decoration: none; color: inherit; display: flex; flex-direction: column;">
                    <h1>Wistron Share</h1>
                    <span class="logo-subtitle">ç·¯å‰µåˆ†äº«å¹³å°</span>
                </a>
            </div>
        </div>
        <div class="header-right" id="headerRight">
            <!-- ç™»å…¥å‰é¡¯ç¤º -->
            <button class="login-btn-header" id="loginBtn" onclick="window.location.href='login.html'" style="display: none;">ç™»å…¥</button>
            
            <!-- ç™»å…¥å¾Œé¡¯ç¤º -->
            <div id="loggedInSection" style="display: none;">
                <button class="upload-btn" onclick="window.location.href='upload.html'">ğŸ“¤ ä¸Šå‚³å…§å®¹</button>
                <div class="user-avatar" id="userAvatar" onclick="showUserMenu()">
                    <img src="" alt="ç”¨æˆ¶é ­åƒ" id="avatarImg" style="display: none;">
                    <span id="avatarInitial">ğŸ‘¤</span>
                    <span class="online-dot"></span>
                </div>
                <div class="user-points" id="userPoints">
                    <span class="points-icon">â­</span>
                    <span class="points-label">çŸ¥è­˜ç©åˆ†ï¼š</span>
                    <span class="points-value" id="pointsValue">0</span>
                </div>
            </div>
        </div>
        
        <!-- ç”¨æˆ¶é¸å–® -->
        <div class="user-menu" id="userMenu" style="display: none;">
            <div class="user-menu-header">
                <div class="user-menu-avatar" id="menuAvatar">
                    <span id="menuAvatarInitial">ğŸ‘¤</span>
                </div>
                <div class="user-menu-info">
                    <div class="user-menu-name" id="menuUserName">ç”¨æˆ¶åç¨±</div>
                    <div class="user-menu-username" id="menuUserUsername">@username</div>
                </div>
            </div>
            <div class="user-menu-divider"></div>
            <a href="#" class="user-menu-item" onclick="window.location.href='index.html'">ğŸ  è¿”å›é¦–é </a>
            <a href="#" class="user-menu-item" onclick="logout()">ğŸšª ç™»å‡º</a>
        </div>
    </header>

    <div class="container">
        <main class="detail-container">
            <!-- å…§å®¹å€åŸŸ -->
            <div class="detail-content">
                <!-- åª’é«”å€åŸŸ -->
                <div class="media-section" id="mediaSection">
                    <!-- å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                </div>

                <!-- è³‡è¨Šå€åŸŸ -->
                <div class="info-section">
                    <h1 id="detailTitle"></h1>
                    
                    <div class="meta-info">
                        <span class="meta-item">
                            <span class="meta-icon">ğŸ“…</span>
                            <span class="meta-label">ç™¼å¸ƒæ™‚é–“ :</span>
                            <span class="meta-value" id="detailDate"></span>
                        </span>
                        <span class="meta-item">
                            <span class="meta-icon">ğŸ‘¤</span>
                            <span class="meta-label">ç™¼è¡¨äºº :</span>
                            <span class="meta-value" id="detailAuthor"></span>
                        </span>
                        <span class="meta-item">
                            <span class="meta-icon">ğŸ‘ï¸</span>
                            <span class="meta-value" id="detailViews">0</span>
                            <span class="meta-label">è§€çœ‹</span>
                        </span>
                        <span class="meta-item">
                            <span class="meta-icon">ğŸ‘</span>
                            <span class="meta-value" id="detailLikes">0</span>
                            <span class="meta-label">è®š</span>
                        </span>
                    </div>

                    <!-- çå‹µå¾½ç«  -->
                    <div class="reward-badge" id="rewardBadge" style="display: none;">
                        <span class="badge-icon">ğŸ†</span>
                        <span class="badge-text" id="badgeText"></span>
                    </div>

                    <!-- æè¿° -->
                    <div class="description">
                        <h3>å…§å®¹æè¿°</h3>
                        <p id="detailDescription"></p>
                    </div>

                    <!-- äº’å‹•æŒ‰éˆ• -->
                    <div class="action-buttons">
                        <button class="action-btn" id="likeBtn" onclick="toggleLike()">
                            <span>ğŸ‘</span> è®š
                        </button>
                        <button class="action-btn" onclick="shareContent()">
                            <span>ğŸ“¤</span> åˆ†äº«
                        </button>
                    </div>
                </div>
            </div>

            <!-- ç•™è¨€å€åŸŸ -->
            <div class="comments-section">
                <div class="comments-header">
                    <h3 id="commentsCount">0 å‰‡ç•™è¨€</h3>
                    <div class="sort-comments">
                        <select id="sortComments">
                            <option value="newest">æœ€æ–°</option>
                            <option value="oldest">æœ€èˆŠ</option>
                            <option value="popular">æœ€å—æ­¡è¿</option>
                        </select>
                    </div>
                </div>

                <!-- ç•™è¨€è¼¸å…¥æ¡† -->
                <div class="comment-input-area">
                    <div class="comment-avatar">
                        <span id="userInitial">ğŸ‘¤</span>
                    </div>
                    <div class="comment-input-wrapper">
                        <input type="text" id="commentInput" placeholder="ç™¼è¡¨ç•™è¨€..." class="comment-input">
                        <button class="comment-submit-btn" onclick="submitComment()">ç•™è¨€</button>
                    </div>
                </div>

                <!-- ç•™è¨€åˆ—è¡¨ -->
                <div class="comments-list" id="commentsList">
                    <!-- ç•™è¨€å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                </div>

                <!-- ç©ºç‹€æ…‹ -->
                <div class="no-comments" id="noComments" style="display: none;">
                    <p>ç›®å‰é‚„æ²’æœ‰ç•™è¨€ï¼Œæˆç‚ºç¬¬ä¸€å€‹ç•™è¨€çš„äººå§ï¼</p>
                </div>
            </div>

            <!-- ç›¸é—œå…§å®¹æ¨è–¦ -->
            <div class="related-section">
                <h3>ç›¸é—œå…§å®¹</h3>
                <div class="related-grid" id="relatedGrid">
                    <!-- å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js?v=2"></script>
    <script src="supabase-api.js?v=2"></script>
    <script src="auth.js"></script>
    <script src="script.js"></script>
    <script>
        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹ä¸¦æ›´æ–° header
        function updateHeaderForAuth() {
            const isLoggedIn = Auth.isLoggedIn();
            const loginBtn = document.getElementById('loginBtn');
            const loggedInSection = document.getElementById('loggedInSection');
            
            if (isLoggedIn) {
                if (loginBtn) loginBtn.style.display = 'none';
                if (loggedInSection) loggedInSection.style.display = 'flex';
                
                const user = Auth.getCurrentUser();
                if (user) {
                    const avatarImg = document.getElementById('avatarImg');
                    const avatarInitial = document.getElementById('avatarInitial');
                    const menuAvatarInitial = document.getElementById('menuAvatarInitial');
                    
                    if (avatarImg && avatarInitial) {
                        if (user.avatar) {
                            avatarImg.src = user.avatar;
                            avatarImg.style.display = 'block';
                            avatarInitial.style.display = 'none';
                        } else {
                            avatarInitial.textContent = user.name ? user.name.charAt(0) : 'ğŸ‘¤';
                        }
                    }
                    
                    if (menuAvatarInitial) {
                        menuAvatarInitial.textContent = user.name ? user.name.charAt(0) : 'ğŸ‘¤';
                    }
                    
                    const menuUserName = document.getElementById('menuUserName');
                    const menuUserUsername = document.getElementById('menuUserUsername');
                    if (menuUserName) menuUserName.textContent = user.name || user.username;
                    if (menuUserUsername) menuUserUsername.textContent = '@' + user.username;
                }
                
                if (typeof loadUserPoints !== 'undefined') {
                    loadUserPoints();
                }
            } else {
                if (loginBtn) loginBtn.style.display = 'block';
                if (loggedInSection) loggedInSection.style.display = 'none';
            }
        }
        
        function showUserMenu() {
            const menu = document.getElementById('userMenu');
            if (menu) {
                menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        function logout() {
            Auth.logout();
        }
        
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('userMenu');
            const avatar = document.getElementById('userAvatar');
            if (menu && avatar && !menu.contains(e.target) && !avatar.contains(e.target)) {
                menu.style.display = 'none';
            }
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            updateHeaderForAuth();
        });
    </script>
    <script>
        // å¾ URL åƒæ•¸ç²å–å…§å®¹ ID
        const urlParams = new URLSearchParams(window.location.search);
        const contentId = urlParams.get('id');

        // è¼‰å…¥å…§å®¹è©³æƒ…
        async function loadContentDetail() {
            const contents = await loadDataFromSupabase();
            const content = contents.find(c => c.id === contentId);

            if (!content) {
                document.querySelector('.detail-container').innerHTML = '<p>æ‰¾ä¸åˆ°æ­¤å…§å®¹</p>';
                return;
            }

            // æ›´æ–°è§€çœ‹æ•¸
            content.views = (content.views || 0) + 1;
            // æ›´æ–°åˆ° Supabaseï¼ˆéåŒæ­¥ï¼Œä¸ç­‰å¾…å®Œæˆï¼‰
            updateContentInSupabase(contentId, { views: content.views }).catch(err => {
                console.error('æ›´æ–°è§€çœ‹æ•¸å¤±æ•—:', err);
            });

            // é¡¯ç¤ºå…§å®¹
            document.getElementById('detailTitle').textContent = content.title;
            document.getElementById('detailAuthor').textContent = content.author;
            document.getElementById('detailDate').textContent = formatDate(content.createdAt);
            document.getElementById('detailViews').textContent = content.views || 0;
            document.getElementById('detailLikes').textContent = content.likes || 0;
            // é¡¯ç¤ºæè¿°ï¼ˆæ”¯æ´å¯Œæ–‡æœ¬æ ¼å¼ï¼‰
            const detailDescription = document.getElementById('detailDescription');
            if (detailDescription) {
                detailDescription.innerHTML = content.description || '';
            }

            // é¡¯ç¤ºåª’é«”
            const mediaSection = document.getElementById('mediaSection');
            // å¦‚æœæ˜¯æœ€æ–°æ¶ˆæ¯ï¼Œéš±è—åª’é«”å€åŸŸ
            if (content.type === 'news') {
                mediaSection.style.display = 'none';
            } else if (content.type === 'video' && content.videoLink) {
                // è™•ç†å¤–éƒ¨å½±ç‰‡é€£çµï¼ˆYouTube/Vimeoï¼‰
                mediaSection.style.display = 'block';
                let embedUrl = '';
                
                // YouTube åµŒå…¥é€£çµ
                const youtubeRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
                const youtubeMatch = content.videoLink.match(youtubeRegex);
                if (youtubeMatch) {
                    embedUrl = `https://www.youtube.com/embed/${youtubeMatch[1]}`;
                }
                
                // Vimeo åµŒå…¥é€£çµ
                const vimeoRegex = /(?:vimeo\.com\/)(\d+)/;
                const vimeoMatch = content.videoLink.match(vimeoRegex);
                if (vimeoMatch) {
                    embedUrl = `https://player.vimeo.com/video/${vimeoMatch[1]}`;
                }
                
                if (embedUrl) {
                    mediaSection.innerHTML = `
                        <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px;">
                            <iframe src="${embedUrl}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;" allowfullscreen></iframe>
                        </div>
                    `;
                } else {
                    mediaSection.innerHTML = `
                        <div style="padding: 2rem; text-align: center; background: #f0f0f0; border-radius: 12px;">
                            <p>ç„¡æ³•è­˜åˆ¥çš„å½±ç‰‡é€£çµæ ¼å¼</p>
                            <a href="${content.videoLink}" target="_blank" style="color: #3b82f6; text-decoration: underline;">é»æ“Šé–‹å•Ÿå½±ç‰‡é€£çµ</a>
                        </div>
                    `;
                }
            } else if (content.type === 'video' && content.fileUrl) {
                mediaSection.style.display = 'block';
                mediaSection.innerHTML = `
                    <video controls style="width: 100%; border-radius: 12px;">
                        <source src="${content.fileUrl}" type="video/mp4">
                        æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å½±ç‰‡æ’­æ”¾ã€‚
                    </video>
                `;
            } else if (content.fileUrl && content.fileUrl.match(/\.(jpg|jpeg|png|gif)$/i)) {
                mediaSection.style.display = 'block';
                mediaSection.innerHTML = `
                    <img src="${content.fileUrl}" style="width: 100%; border-radius: 12px;" alt="${content.title}">
                `;
            } else if (content.type === 'project' && content.githubLink) {
                mediaSection.style.display = 'block';
                mediaSection.innerHTML = `
                    <div class="project-preview">
                        <div class="github-card">
                            <div class="github-icon">ğŸ’»</div>
                            <h3>GitHub å°ˆæ¡ˆ</h3>
                            <p class="github-link-text">${content.githubLink}</p>
                            <a href="${content.githubLink}" target="_blank" class="github-btn">
                                <span>ğŸ”—</span> å‰å¾€ GitHub
                            </a>
                        </div>
                    </div>
                `;
            } else if (content.type === 'expert') {
                // æ‰¾å…§éƒ¨å°ˆå®¶ä¹Ÿéš±è—åª’é«”å€åŸŸ
                mediaSection.style.display = 'none';
            } else {
                mediaSection.style.display = 'block';
                mediaSection.innerHTML = `
                    <div class="placeholder-media">
                        <span class="placeholder-icon">${content.type === 'video' ? 'ğŸ¬' : content.type === 'article' ? 'ğŸ“„' : content.type === 'project' ? 'ğŸ’»' : 'ğŸ’­'}</span>
                        <p>${content.type === 'video' ? 'å½±ç‰‡åˆ†äº«' : content.type === 'article' ? 'æ–‡ç« åˆ†äº«' : content.type === 'project' ? 'ä½œå“åˆ†äº«' : content.type === 'suggestion' ? 'æ‡¸è³å€' : content.type === 'job' ? 'å°ˆæ¡ˆæ”¯æ´æŠ€èƒ½åª’åˆ' : content.type === 'news' ? 'æœ€æ–°æ¶ˆæ¯' : content.type === 'expert' ? 'æ‰¾å…§éƒ¨å°ˆå®¶' : ''}</p>
                    </div>
                `;
            }

            // å¦‚æœæ˜¯å®˜æ–¹å…¬å‘Šï¼Œæ·»åŠ ç‰¹æ®Šæ¨™è¨˜
            if (content.isOfficial) {
                const infoSection = document.querySelector('.info-section');
                const officialBadge = document.createElement('div');
                officialBadge.className = 'official-announcement-badge';
                officialBadge.innerHTML = '<span>ğŸ“¢</span> å®˜æ–¹å…¬å‘Š';
                infoSection.insertBefore(officialBadge, infoSection.firstChild);
            }

            // å¦‚æœæ˜¯æœ€æ–°æ¶ˆæ¯ï¼Œé¡¯ç¤ºæ™‚é–“è³‡è¨Š
            if (content.type === 'news') {
                const metaInfo = document.querySelector('.meta-info');
                if (content.startDate || content.endDate) {
                    const timeInfo = document.createElement('div');
                    timeInfo.className = 'news-time-info';
                    let timeHTML = '<div class="time-info-row">';
                    if (content.startDate) {
                        timeHTML += `<div class="time-item"><span class="time-label">â° é–‹å§‹æ™‚é–“ï¼š</span><span class="time-value">${formatNewsDate(content.startDate)}</span></div>`;
                    }
                    if (content.endDate) {
                        timeHTML += `<div class="time-item"><span class="time-label">ğŸ çµæŸæ™‚é–“ï¼š</span><span class="time-value">${formatNewsDate(content.endDate)}</span></div>`;
                    }
                    timeHTML += '</div>';
                    timeInfo.innerHTML = timeHTML;
                    metaInfo.parentNode.insertBefore(timeInfo, metaInfo.nextSibling);
                }
            }

            // å¦‚æœæ˜¯å°ˆæ¡ˆæ”¯æ´åŠæŠ€èƒ½åª’åˆï¼Œé¡¯ç¤ºè©³ç´°è³‡è¨Š
            if (content.type === 'job') {
                const descriptionDiv = document.querySelector('.description');
                let jobInfoHTML = '<div class="job-details">';
                jobInfoHTML += '<div class="job-detail-item"><span class="detail-label">ğŸ“ å°ˆæ¡ˆåœ°é»/é ç«¯ï¼š</span><span class="detail-value">' + content.jobLocation + '</span></div>';
                if (content.jobDepartment) {
                    jobInfoHTML += '<div class="job-detail-item"><span class="detail-label">ğŸ¢ å°ˆæ¡ˆ/éƒ¨é–€ï¼š</span><span class="detail-value">' + content.jobDepartment + '</span></div>';
                }
                if (content.jobType) {
                    jobInfoHTML += '<div class="job-detail-item"><span class="detail-label">â° æ”¯æ´é¡å‹ï¼š</span><span class="detail-value">' + content.jobType + '</span></div>';
                }
                if (content.jobSalary) {
                    jobInfoHTML += '<div class="job-detail-item"><span class="detail-label">â±ï¸ æ™‚é–“éœ€æ±‚/å ±é…¬ï¼š</span><span class="detail-value">' + content.jobSalary + '</span></div>';
                }
                if (content.jobRequirements) {
                    jobInfoHTML += '<div class="job-detail-item job-requirements"><span class="detail-label">ğŸ› ï¸ éœ€è¦çš„æŠ€èƒ½/å°ˆé•·ï¼š</span><div class="detail-value">' + content.jobRequirements.replace(/\n/g, '<br>') + '</div></div>';
                }
                if (content.jobContact) {
                    jobInfoHTML += '<div class="job-detail-item job-contact"><span class="detail-label">ğŸ“ è¯çµ¡æ–¹å¼ï¼š</span><span class="detail-value">' + content.jobContact + '</span></div>';
                }
                jobInfoHTML += '</div>';
                
                const jobInfoDiv = document.createElement('div');
                jobInfoDiv.className = 'job-info-section';
                jobInfoDiv.innerHTML = jobInfoHTML;
                descriptionDiv.parentNode.insertBefore(jobInfoDiv, descriptionDiv);
            }

            // é¡¯ç¤ºçå‹µå¾½ç« 
            if (content.reward) {
                const badge = document.getElementById('rewardBadge');
                const badgeText = document.getElementById('badgeText');
                badge.style.display = 'flex';
                
                if (content.reward === 'gold') {
                    badge.classList.add('gold');
                    badgeText.textContent = 'ğŸ… é‡‘ç‰Œçå‹µ';
                } else if (content.reward === 'silver') {
                    badge.classList.add('silver');
                    badgeText.textContent = 'ğŸ¥ˆ éŠ€ç‰Œçå‹µ';
                } else if (content.reward === 'bronze') {
                    badge.classList.add('bronze');
                    badgeText.textContent = 'ğŸ¥‰ éŠ…ç‰Œçå‹µ';
                }
            }

            // è¼‰å…¥ç›¸é—œå…§å®¹
            loadRelatedContent(content);
            
            // è¼‰å…¥ç•™è¨€
            loadComments();
            
            // è¼‰å…¥ç›¸é—œå…§å®¹
            loadRelatedContent(content);
        }

        async function loadRelatedContent(currentContent) {
            const contents = await loadDataFromSupabase();
            const related = contents
                .filter(c => c.id !== currentContent.id && c.type === currentContent.type)
                .slice(0, 5);

            const relatedGrid = document.getElementById('relatedGrid');
            if (related.length === 0) {
                relatedGrid.innerHTML = '<p>æš«ç„¡ç›¸é—œå…§å®¹</p>';
                return;
            }

            relatedGrid.innerHTML = related.map((content, index) => {
                const patternClass = getRandomPattern(index);
                const colorClass = getRandomColor(index);
                return `
                <div class="content-card" onclick="window.location.href='detail.html?id=${content.id}'">
                    <div class="card-thumbnail">
                        ${content.fileUrl ? `<img src="${content.fileUrl}" alt="${content.title}">` : 
                          `<div class="placeholder-thumbnail ${patternClass} ${colorClass}">${content.type === 'video' ? 'ğŸ¬' : content.type === 'article' ? 'ğŸ“„' : content.type === 'project' ? 'ğŸ’»' : 'ğŸ’­'}</div>`}
                    </div>
                    <div class="card-info">
                        <h4>${content.title}</h4>
                        <p class="card-author">${content.author}</p>
                        <div class="card-stats">
                            <span>ğŸ‘ï¸ ${content.views || 0}</span>
                            ${content.reward ? `<span class="reward-indicator">ğŸ†</span>` : ''}
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        function getRandomPattern(index) {
            const patterns = ['pattern-dots', 'pattern-lines', 'pattern-grid', 'pattern-circles', 'pattern-diagonal'];
            return patterns[index % patterns.length];
        }

        function getRandomColor(index) {
            const colors = ['color-blue', 'color-purple', 'color-green', 'color-orange', 'color-pink', 'color-teal'];
            return colors[index % colors.length];
        }

        async function toggleLike() {
            const contents = await loadDataFromSupabase();
            const content = contents.find(c => c.id === contentId);
            
            if (content) {
                content.likes = (content.likes || 0) + 1;
                document.getElementById('detailLikes').textContent = content.likes;
                
                const likeBtn = document.getElementById('likeBtn');
                likeBtn.style.opacity = '0.6';
                likeBtn.disabled = true;
                
                // æ›´æ–°åˆ° Supabase
                try {
                    await updateContentInSupabase(contentId, { likes: content.likes });
                } catch (error) {
                    console.error('æ›´æ–°æŒ‰è®šæ•¸å¤±æ•—:', error);
                }
            }
        }

        function shareContent() {
            const url = window.location.href;
            if (navigator.share) {
                navigator.share({
                    title: document.getElementById('detailTitle').textContent,
                    url: url
                });
            } else {
                navigator.clipboard.writeText(url);
                alert('é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const hours = date.getHours();
            const minutes = date.getMinutes();
            
            // è½‰æ›ç‚ºä¸­æ–‡æ—¥æœŸæ ¼å¼
            const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
            const monthName = monthNames[month - 1];
            
            // åˆ¤æ–·ä¸Šåˆ/ä¸‹åˆ
            const period = hours >= 12 ? 'ä¸‹åˆ' : 'ä¸Šåˆ';
            const displayHours = hours > 12 ? hours - 12 : (hours === 0 ? 12 : hours);
            const displayMinutes = minutes.toString().padStart(2, '0');
            
            return `${year}å¹´${month}æœˆ${day}æ—¥${period}${displayHours}:${displayMinutes}`;
        }

        function formatNewsDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-TW', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatCommentDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return 'ä»Šå¤©';
            } else if (diffDays === 1) {
                return '1å¤©å‰';
            } else if (diffDays < 7) {
                return `${diffDays}å¤©å‰`;
            } else if (diffDays < 30) {
                const weeks = Math.floor(diffDays / 7);
                return `${weeks}é€±å‰`;
            } else {
                return date.toLocaleDateString('zh-TW', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            }
        }

        // è¼‰å…¥ç•™è¨€
        async function loadComments() {
            try {
                const comments = await loadCommentsFromSupabase(contentId);
                const sortType = document.getElementById('sortComments').value;
                
                let sortedComments = [...comments];
                if (sortType === 'newest') {
                    sortedComments.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                } else if (sortType === 'oldest') {
                    sortedComments.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                } else if (sortType === 'popular') {
                    sortedComments.sort((a, b) => (b.likes || 0) - (a.likes || 0));
                }

                const commentsList = document.getElementById('commentsList');
                const noComments = document.getElementById('noComments');
                const commentsCount = document.getElementById('commentsCount');

                commentsCount.textContent = `${comments.length} å‰‡ç•™è¨€`;

                if (sortedComments.length === 0) {
                    commentsList.style.display = 'none';
                    noComments.style.display = 'block';
                    return;
                }

                commentsList.style.display = 'block';
                noComments.style.display = 'none';

                commentsList.innerHTML = sortedComments.map(comment => `
                    <div class="comment-item">
                        <div class="comment-avatar-small">
                            <span>${getUserInitial(comment.author)}</span>
                        </div>
                        <div class="comment-content">
                            <div class="comment-header">
                                <span class="comment-author">${comment.author}</span>
                                <span class="comment-date">${formatCommentDate(comment.createdAt)}</span>
                            </div>
                            <div class="comment-text">${escapeHtml(comment.content)}</div>
                            <div class="comment-actions">
                                <button class="comment-action-btn" onclick="likeComment('${comment.id}')">
                                    <span>ğŸ‘</span> ${comment.likes || 0}
                                </button>
                                <button class="comment-action-btn" onclick="replyComment('${comment.id}', '${comment.author}')">
                                    å›è¦†
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('è¼‰å…¥ç•™è¨€å¤±æ•—:', error);
                // å‚™æ´ï¼šä½¿ç”¨ localStorage
                const comments = JSON.parse(localStorage.getItem(`comments_${contentId}`) || '[]');
                const sortType = document.getElementById('sortComments').value;
                
                let sortedComments = [...comments];
                if (sortType === 'newest') {
                    sortedComments.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                } else if (sortType === 'oldest') {
                    sortedComments.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                } else if (sortType === 'popular') {
                    sortedComments.sort((a, b) => (b.likes || 0) - (a.likes || 0));
                }

                const commentsList = document.getElementById('commentsList');
                const noComments = document.getElementById('noComments');
                const commentsCount = document.getElementById('commentsCount');

                commentsCount.textContent = `${comments.length} å‰‡ç•™è¨€`;

                if (sortedComments.length === 0) {
                    commentsList.style.display = 'none';
                    noComments.style.display = 'block';
                    return;
                }

                commentsList.style.display = 'block';
                noComments.style.display = 'none';

                commentsList.innerHTML = sortedComments.map(comment => `
                    <div class="comment-item">
                        <div class="comment-avatar-small">
                            <span>${getUserInitial(comment.author)}</span>
                        </div>
                        <div class="comment-content">
                            <div class="comment-header">
                                <span class="comment-author">${comment.author}</span>
                                <span class="comment-date">${formatCommentDate(comment.createdAt)}</span>
                            </div>
                            <div class="comment-text">${escapeHtml(comment.text || comment.content)}</div>
                            <div class="comment-actions">
                                <button class="comment-action-btn" onclick="likeComment('${comment.id}')">
                                    <span>ğŸ‘</span> ${comment.likes || 0}
                                </button>
                                <button class="comment-action-btn" onclick="replyComment('${comment.id}', '${comment.author}')">
                                    å›è¦†
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // æäº¤ç•™è¨€
        async function submitComment() {
            const input = document.getElementById('commentInput');
            const text = input.value.trim();
            
            if (!text) {
                alert('è«‹è¼¸å…¥ç•™è¨€å…§å®¹');
                return;
            }

            const comment = {
                author: getCurrentUser(),
                content: text
            };

            try {
                const result = await addCommentToSupabase(contentId, comment);
                if (result.success) {
                    input.value = '';
                    await loadComments();
                } else {
                    alert('ç•™è¨€æäº¤å¤±æ•—ï¼š' + result.message);
                }
            } catch (error) {
                console.error('æäº¤ç•™è¨€å¤±æ•—:', error);
                // å‚™æ´ï¼šä½¿ç”¨ localStorage
                const commentData = {
                    id: Date.now().toString(),
                    author: comment.author,
                    text: comment.content,
                    createdAt: new Date().toISOString(),
                    likes: 0
                };
                const comments = JSON.parse(localStorage.getItem(`comments_${contentId}`) || '[]');
                comments.push(commentData);
                localStorage.setItem(`comments_${contentId}`, JSON.stringify(comments));
                input.value = '';
                await loadComments();
            }
        }

        // é»è®šç•™è¨€
        async function likeComment(commentId) {
            try {
                const comments = await loadCommentsFromSupabase(contentId);
                const comment = comments.find(c => c.id === commentId);
                
                if (comment) {
                    const newLikes = (comment.likes || 0) + 1;
                    await updateCommentInSupabase(commentId, { likes: newLikes });
                    await loadComments();
                }
            } catch (error) {
                console.error('é»è®šç•™è¨€å¤±æ•—:', error);
                // å‚™æ´ï¼šä½¿ç”¨ localStorage
                const comments = JSON.parse(localStorage.getItem(`comments_${contentId}`) || '[]');
                const comment = comments.find(c => c.id === commentId);
                
                if (comment) {
                    comment.likes = (comment.likes || 0) + 1;
                    localStorage.setItem(`comments_${contentId}`, JSON.stringify(comments));
                    await loadComments();
                }
            }
        }

        // å›è¦†ç•™è¨€
        function replyComment(commentId, authorName) {
            const input = document.getElementById('commentInput');
            input.value = `@${authorName} `;
            input.focus();
        }

        // ç²å–ç•¶å‰ç”¨æˆ¶ï¼ˆç°¡åŒ–ç‰ˆï¼Œå¯¦éš›æ‡‰è©²å¾ç™»å…¥ç³»çµ±ç²å–ï¼‰
        function getCurrentUser() {
            let user = localStorage.getItem('currentUser');
            if (!user) {
                user = 'è¨ªå®¢' + Math.floor(Math.random() * 1000);
                localStorage.setItem('currentUser', user);
            }
            return user;
        }

        // ç²å–ç”¨æˆ¶åç¨±é¦–å­—
        function getUserInitial(name) {
            if (name && name.length > 0) {
                return name.charAt(0).toUpperCase();
            }
            return 'ğŸ‘¤';
        }

        // HTML è½‰ç¾©
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ç•™è¨€è¼¸å…¥æ¡† Enter éµæäº¤
        document.addEventListener('DOMContentLoaded', function() {
            const commentInput = document.getElementById('commentInput');
            if (commentInput) {
                commentInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        submitComment();
                    }
                });
            }

            const sortComments = document.getElementById('sortComments');
            if (sortComments) {
                sortComments.addEventListener('change', function() {
                    loadComments();
                });
            }
        });

        // è¼‰å…¥ç”¨æˆ¶ç©åˆ†
        async function loadUserPoints() {
            try {
                const currentAuthor = localStorage.getItem('currentAuthor');
                if (currentAuthor && typeof getUserPoints !== 'undefined') {
                    const points = await getUserPoints(currentAuthor);
                    const pointsValue = document.getElementById('pointsValue');
                    if (pointsValue) {
                        pointsValue.textContent = points;
                    }
                } else {
                    const userPoints = document.getElementById('userPoints');
                    if (userPoints) {
                        userPoints.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('è¼‰å…¥ç”¨æˆ¶ç©åˆ†å¤±æ•—:', error);
            }
        }

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        if (contentId) {
            loadContentDetail();
            loadUserPoints();
        } else {
            document.querySelector('.detail-container').innerHTML = '<p>ç„¡æ•ˆçš„å…§å®¹ ID</p>';
        }
    </script>
</body>
</html>

